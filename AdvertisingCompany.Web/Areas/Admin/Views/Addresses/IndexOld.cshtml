@{
    ViewBag.Title = "Администрирование | Рекламные объекты";
}

<h1 class="page-title">
    Рекламные объекты
</h1>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success alert-dismissible mrgtop12" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        @TempData["Message"]
    </div>
}

@*<div class="row">
    <div class="col-md-3 mrgbtm24">
        <a href="@Url.Action("Create", "Address", new { area = "Admin" })" class="btn btn-default full-width" data-bind="tooltip: { title: 'Добавить рекламный объект', placement: 'top', trigger: 'hover' }">
            <span class="glyphicon glyphicon-plus action-icon-font"></span>
            Добавить рекламный объект
        </a>
    </div>

    <!-- ko if: Addresses().length > 0 -->
    <div class="col-md-3 col-md-offset-6 mrgbtm24">
        <input class="form-control" placeholder="Поиск..."/>
    </div>
    <!-- /ko -->
</div>*@


<div class="row">
    <div class="col-md-12">
        <section class="widget">
            <header>

                <!-- Filter -->
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div class="col-md-12">
                            <div class="row mrgtop12">
                                <div class="col-md-4">
                                    @*<label for="cities">Город:</label>*@
                                    <select class="form-control" id="cities" name="city" data-bind="value: SelectedCityId, event : { change : loadAreas }">
                                        <option value="">Выберите город</option>
                                        <!-- ko foreach: Cities -->
                                        <option data-bind="attr: { value: CityId }, text: CityName"></option>
                                        <!-- /ko -->
                                    </select>
                                </div>
                                <div class="col-md-4 mrgbtm12">
                                    @*<label for="areas">Район:</label>*@
                                    <select class="form-control" id="areas" name="area" data-bind="value: SelectedAreaId">
                                        <option value="">Выберите район</option>
                                        <!-- ko foreach: Areas -->
                                        <option data-bind="attr: { value: AreaId }, text: AreaName"></option>
                                        <!-- /ko -->
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    @*<label>Адрес:</label>*@
                                    <input type="text" class="form-control" placeholder="Введите улицу" data-bind="value: SelectedStreet" />
                                </div>
                                <div class="col-md-1">
                                    @*<label>Дом:</label>*@
                                    <input type="text" class="form-control" placeholder="Дом" data-bind="value: SelectedHouse" />
                                </div>
                            </div>

                            <div class="row mrgbtm12">
                                <div class="col-md-3">
                                </div>
                                <div class="col-md-3">
                                    <button data-bind="click: loadAddresses" class="btn btn-success full-width"><span class="glyphicon glyphicon-ok"></span> Применить фильтр</button>
                                </div>
                                <div class="col-md-3">
                                    <button data-bind="click: clearFilter" class="btn btn-primary full-width"><span class="glyphicon glyphicon-refresh"></span> Сбросить фильтр</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End of filter -->

                <div class="row">
                    <div class="col-md-3 mrgbtm24">
                        <a href="@Url.Action("Create", "Address", new { area = "Admin" })" class="btn btn-inverse full-width" data-bind="tooltip: { title: 'Добавить рекламный объект', placement: 'top', trigger: 'hover' }">
                            <span class="glyphicon glyphicon-plus action-icon-font"></span>
                            Добавить
                        </a>
                    </div>
                </div>
                @*<h4>
                    Table <span class="fw-semi-bold">Styles</span>
                </h4>*@
                <div class="widget-controls">
                    @*<a href="#"><i class="glyphicon glyphicon-cog"></i></a>
                        <a data-widgster="close" href="#"><i class="glyphicon glyphicon-remove"></i></a>*@
                </div>
            </header>
            <div class="widget-body">

                <!-- Progress -->
                <div id="progress" class="row" style="display: none">
                    <div class="col-md-4 col-md-offset-4">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                                <span class="sr-only">100% Complete</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End of progress -->

                <!-- Addresses list -->
                <!-- ko if: Addresses().length > 0 -->
                <div class="table-responsive">
                    <table class="table table-hover table-condensed">
                        <thead>
                            <tr>
                                <th class="text-center">№</th>
                                <th>Город</th>
                                <th class="text-center">Район</th>
                                <th class="text-center">Улица</th>
                                <th class="text-center">Номер дома</th>
                                <th class="text-center">Подъезд</th>
                                <th class="text-center">Действия</th>
                            </tr>
                        </thead>
                        <tbody data-bind="foreach: Addresses">
                            <tr>
                                <td class="text-center" data-bind="text: ((($root.SelectedPage() - 1) * $root.SelectedPageSize()) + $index() + 1) + '.'"></td>
                                <td data-bind="text: City()"></td>
                                <td class="text-center" data-bind="text: Area()"></td>
                                <td class="text-center" data-bind="text: Street()"></td>
                                <td class="text-center" data-bind="text: HouseNumber() + (BuildingNumber() != '' ? '/' : '') + BuildingNumber()"></td>
                                <td class="text-center" data-bind="text: PorchNumber()"></td>
                                <td class="text-center">
                                    <a href="#" class="btn btn-link action-link" data-bind="attr: { 'href' : '#' }, tooltip: { title: 'Перейти к редактированию рекламного объекта', trigger: 'hover' }">
                                        <span class="glyphicon glyphicon-pencil text-success icon">
                                        </span>
                                    </a>
                                    <a href="#" class="btn btn-link action-link" data-bind="attr: { 'href' : '/Report/?addressId=' + AddressId() }, tooltip: { title: 'Просмотреть отчеты', trigger: 'hover' }">
                                        <span class="glyphicon glyphicon-folder-open text-warning icon"></span>
                                    </a>
                                    <a href="#" class="btn btn-link action-link" data-bind="attr: { 'href' : '/Report/?addressId=' + AddressId() }, tooltip: { title: 'Просмотреть на карте', trigger: 'hover' }">
                                        <span class="glyphicon glyphicon-map-marker text-danger icon"></span>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- /ko -->
                <!-- End of addresses list -->

                <!-- Pagination -->
                <!-- ko if: Addresses().length > 0 -->
                <div class="row text-center">
                    <div class="col-md-3">
                        <form class="form-inline">
                            <div class="form-group">
                                <label for="">Показывать записей: </label>
                                <select class="form-control" data-bind="options: PageSizes, value: SelectedPageSize,event : { change: pageSizeChanged }"></select>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <!-- ko if: PagesCount() > 1 -->
                        <nav>
                            <ul class="pagination">
                                <li>
                                    <a href="#" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>

                                <!-- ko foreach: new Array(PagesCount()) -->
                                <!-- ko if: $index() >= $root.SelectedPage() - 4 && $index() <= $root.SelectedPage() + 2 -->
                                <li data-bind="attr: { 'class' : $root.SelectedPage() == ($index() + 1) ? 'active' : '' }">
                                    <a href="#" data-bind="text: $index()+1, click: function () { $root.selectedPageChanged($index() + 1); }"></a>
                                </li>
                                <!-- /ko -->
                                <!-- /ko -->
                                <li>
                                    <a href="#" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                        <!-- /ko -->
                    </div>
                </div>
                <!-- /ko -->
                <!-- End of pagination -->
            </div>
        </section>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/knockout")
    <script src="~/Scripts/progress.js"></script>

    <script>

        function MainViewModel() {
            var self = this;

            self.Addresses = ko.observableArray([]);
            self.Cities = ko.observableArray([]);
            self.Areas = ko.observableArray([]);

            self.SelectedPage = ko.observable(1);
            self.PagesCount = ko.observable('');
            self.PageSizes = ko.observableArray([10, 25, 50, 100, 200]);
            self.SelectedPageSize = ko.observable(10);

            self.SelectedCityId = ko.observable('');
            self.SelectedAreaId = ko.observable('');
            self.SelectedStreet = ko.observable('');
            self.SelectedHouse = ko.observable('');

            self.loadAddresses = function () {
                Progress.Show();
                $.post('/Admin/Address/Get', {
                    page: self.SelectedPage(),
                    pageSize: self.SelectedPageSize()
                }, function (response) {
                    ko.mapping.fromJS(response.Addresses,
                        {
                            key: function (data) {
                                return ko.utils.unwrapObservable(data.UserId);
                            },
                            create: function (options) {
                                return new AddressViewModel(options.data);
                            }
                        },
                        self.Addresses
                    );
                    self.PagesCount(response.PagesCount);
                    Progress.Hide();
                });
            };

            self.loadCities = function () {
                self.Cities([]);

                $.post('/Address/GetCities', function (cities) {
                    self.Cities(cities);
                });
            };

            self.loadAreas = function () {
                self.Areas([]);

                $.post('/Address/GetAreas', { cityId: self.SelectedCityId }, function (areas) {
                    self.Areas(areas);
                });
            };

            self.selectedPageChanged = function (page) {
                self.SelectedPage(page);
                self.loadAddresses();

                window.scrollTo(0, 0);
            };

            self.pageSizeChanged = function () {
                self.SelectedPage(1);
                self.loadAddresses();

                window.scrollTo(0, 0);
            };

            self.clearFilter = function () {
                self.SelectedPage(1);

                self.loadAddresses();
            };
        }

        // Bindings
        ko.bindingHandlers.tooltip = {
            init: function (element, valueAccessor) {
                var local = ko.utils.unwrapObservable(valueAccessor()),
                    options = {};

                ko.utils.extend(options, ko.bindingHandlers.tooltip.options);
                ko.utils.extend(options, local);

                $(element).tooltip(options);

                ko.utils.domNodeDisposal.addDisposeCallback(element, function () {
                    $(element).tooltip("destroy");
                });
            },
            options: {
                placement: "top",
                trigger: "click"
            }
        };

        function AddressViewModel(addressViewModel) {
            var self = this;
            self.AddressId = ko.observable(addressViewModel.AddressId || '');
            self.City = ko.observable(addressViewModel.City || '');
            self.Area = ko.observable(addressViewModel.Area || '');
            self.Street = ko.observable(addressViewModel.Street || '');
            self.HouseNumber = ko.observable(addressViewModel.HouseNumber || '');
            self.BuildingNumber = ko.observable(addressViewModel.BuildingNumber || '');
            self.PorchNumber = ko.observable(addressViewModel.PorchNumber || '');
        }

        var viewModel = new MainViewModel();
        $(function () {
            ko.applyBindings(viewModel);
            viewModel.loadAddresses();
            viewModel.loadCities();

            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>
}