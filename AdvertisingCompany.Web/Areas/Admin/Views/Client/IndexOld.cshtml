
@{
    ViewBag.Title = "Администрирование | Клиенты";
}

<h1 class="page-title">
    Клиенты рекламной компании
</h1>

<div class="page-header">
    <h1>
        Клиенты рекламной компании <small></small>
    </h1>
</div>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success alert-dismissible mrgtop12" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        @TempData["Message"]
    </div>
}

<div class="row">
    <div class="col-md-3 mrgbtm24">
        <a href="@Url.Action("Register", "Account")" class="btn btn-default full-width" data-bind="tooltip: { title: 'Добавить клиента рекламной компании', placement: 'top', trigger: 'hover' }">
            <span class="glyphicon glyphicon-plus action-icon-font"></span>
            Добавить клиента
        </a>
    </div>

    <!-- ko if: Clients().length > 0 -->
    <div class="col-md-3 col-md-offset-6 mrgbtm24">
        <input class="form-control" placeholder="Поиск..."/>
    </div>
    <!-- /ko -->
</div>

<!-- Progress -->
<div id="progress" class="row" style="display: none">
    <div class="col-md-4 col-md-offset-4">
        <div class="progress">
            <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                <span class="sr-only">100% Complete</span>
            </div>
        </div>
    </div>
</div>
<!-- End of progress -->

<!-- Clients list -->
<!-- ko if: Clients().length > 0 -->
<div class="table-responsive">
    <table class="table table-hover table-condensed">
        <thead>
            <tr>
                <th class="text-center">№</th>
                <th>Ф.И.О</th>
                <th class="text-center">Логин</th>
                <th class="text-center">Дата регистрации</th>
                <th class="text-center">Действия</th>
            </tr>
        </thead>
        <tbody data-bind="foreach: Clients">
            <tr>
                <td class="text-center" data-bind="text: ((($root.SelectedPage() - 1) * $root.SelectedPageSize()) + $index() + 1) + '.'"></td>
                <td data-bind="text: FullName()"></td>
                <td class="text-center" data-bind="text: Login()"></td>
                <td class="text-center" data-bind="text: CreatedAt()"></td>
                <td class="text-center">
                    <a href="#" class="btn btn-link action-link" data-bind="attr: { 'href' : '#' }, tooltip: { title: 'Перейти к смене пароля', trigger: 'hover' }">
                        <span class="glyphicon glyphicon-lock text-success icon">
                        </span>
                        Изменить пароль
                    </a>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<!-- /ko -->
<!-- End of clients list -->

<!-- Pagination -->
<!-- ko if: Clients().length > 0 -->
<div class="row text-center">
    <div class="col-md-3">
        <form class="form-inline">
            <div class="form-group">
                <label for="">Показывать записей: </label>
                <select class="form-control" data-bind="options: PageSizes, value: SelectedPageSize,event : { change: pageSizeChanged }"></select>
            </div>
        </form>
    </div>
    <div class="col-md-6">
        <!-- ko if: PagesCount() > 1 -->
        <nav>
            <ul class="pagination">
                <li>
                    <a href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>

                <!-- ko foreach: new Array(PagesCount()) -->
                <!-- ko if: $index() >= $root.SelectedPage() - 4 && $index() <= $root.SelectedPage() + 2 -->
                <li data-bind="attr: { 'class' : $root.SelectedPage() == ($index() + 1) ? 'active' : '' }">
                    <a href="#" data-bind="text: $index()+1, click: function () { $root.selectedPageChanged($index() + 1); }"></a>
                </li>
                <!-- /ko -->
                <!-- /ko -->
                <li>
                    <a href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
        <!-- /ko -->
    </div>
</div>
<!-- /ko -->
<!-- End of pagination -->

@section Scripts {
    @Scripts.Render("~/bundles/knockout")
    <script src="~/Scripts/progress.js"></script>

    <script>

        function MainViewModel() {
            var self = this;

            self.Clients = ko.observableArray([]);
            self.SelectedPage = ko.observable(1);
            self.PagesCount = ko.observable('');
            self.PageSizes = ko.observableArray([10, 25, 50, 100, 200]);
            self.SelectedPageSize = ko.observable(10);

            self.loadClients = function () {
                Progress.Show();
                $.post('/Admin/Client/Get', {
                    page: self.SelectedPage(),
                    pageSize: self.SelectedPageSize()
                }, function (response) {
                    ko.mapping.fromJS(response.Clients,
                        {
                            key: function (data) {
                                return ko.utils.unwrapObservable(data.UserId);
                            },
                            create: function (options) {
                                return new ClientViewModel(options.data);
                            }
                        },
                        self.Clients
                    );
                    self.PagesCount(response.PagesCount);
                    Progress.Hide();
                });
            };

            self.selectedPageChanged = function (page) {
                self.SelectedPage(page);
                self.loadClients();

                window.scrollTo(0, 0);
            };

            self.pageSizeChanged = function () {
                self.SelectedPage(1);
                self.loadClients();

                window.scrollTo(0, 0);
            };

            self.clearFilter = function () {
                self.SelectedPage(1);
                self.ClientId('');

                self.loadClients();
            };
        }

        // Bindings
        ko.bindingHandlers.tooltip = {
            init: function (element, valueAccessor) {
                var local = ko.utils.unwrapObservable(valueAccessor()),
                    options = {};

                ko.utils.extend(options, ko.bindingHandlers.tooltip.options);
                ko.utils.extend(options, local);

                $(element).tooltip(options);

                ko.utils.domNodeDisposal.addDisposeCallback(element, function () {
                    $(element).tooltip("destroy");
                });
            },
            options: {
                placement: "top",
                trigger: "click"
            }
        };

        function ClientViewModel(clientViewModel) {
            var self = this;
            self.UserId = ko.observable(clientViewModel.UserId || '');
            self.FullName = ko.observable(clientViewModel.FullName || '');
            self.Login = ko.observable(clientViewModel.Login || '');
            self.CreatedAt = ko.observable(clientViewModel.CreatedAt || '');
        }

        var viewModel = new MainViewModel();
        $(function () {
            ko.applyBindings(viewModel);
            viewModel.loadClients();

            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>
}